/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Core","./ExportDialog","sap/ui/base/EventProvider","sap/ui/Device","sap/ui/export/SpreadsheetExport","sap/base/Log","sap/ui/export/ExportUtils"],function(e,t,r,o,i,s,n){"use strict";var a="sap.ui.export.Spreadsheet";var u=r.extend(a,{constructor:function(e){r.call(this,e);this._mSettings={customizing:{},fileName:"Export",showProgress:true,worker:true};["count","dataSource","fileName","fileType","showProgress","workbook","worker"].forEach(function(t){if(typeof e[t]!=="undefined"){this._mSettings[t]=t!=="dataSource"?e[t]:this.processDataSource(e[t])}}.bind(this));this.codeListsPromise=this.codeListsPromise instanceof Promise?this.codeListsPromise:Promise.resolve()}});function c(e,t,r){if(!(r[e]instanceof Object)){r[e]={}}if(!isNaN(t.digits)){r[e].scale=t.digits}if(!isNaN(t.UnitSpecificScale)){r[e].scale=t.UnitSpecificScale}if(isNaN(r[e].scale)){delete r[e]}}u.prototype.setDefaultExportSettings=function(t){var r,o,i;o=t.customizing.currency={};var s=e.getConfiguration().getFormatSettings().getCustomCurrencies();if(s){for(r in s){c(r,s[r],o)}}return this.codeListsPromise.then(function(e){var r,s,n;if(!Array.isArray(e)){return}i=t.customizing.unit={};r=e[0];s=e[1];for(n in r){c(n,r[n],o)}for(n in s){c(n,s[n],i)}}).then(function(){return e.getLibraryResourceBundle("sap.ui.export",true)}).then(function(e){var r=t.workbook.context;if(!(r instanceof Object)){r=t.workbook.context={}}if(!r.title){r.title=e.getText("XLSX_DEFAULT_TITLE")}if(!r.sheetName){r.sheetName=e.getText("XLSX_DEFAULT_SHEETNAME")}})};u.requestCodeLists=function(e){if(!e.isA(["sap.ui.model.odata.ODataMetaModel","sap.ui.model.odata.v4.ODataMetaModel"])){return Promise.resolve([null,null])}return Promise.all([e.requestCurrencyCodes(),e.requestUnitsOfMeasure()]).catch(function(e){s.warning(a+": Code lists cannot be processed due to the following error - "+e);return Promise.resolve([null,null])})};u.prototype.attachBeforeExport=function(e,t,r){return this.attachEvent("beforeExport",e,t,r)};u.prototype.detachBeforeExport=function(e,t){return this.detachEvent("beforeExport",e,t)};u.prototype.attachBeforeSave=function(e,t,r){return this.attachEvent("beforeSave",e,t,r)};u.prototype.detachBeforeSave=function(e,t){return this.detachEvent("beforeSave",e,t)};u.prototype.destroy=function(){r.prototype.destroy.apply(this,arguments);this.cancel();this.bIsDestroyed=true};u.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null}return this};u.prototype.onprogress=function(e,t){var r;if(isNaN(e)||isNaN(t)){return}r=Math.round(e/t*100);s.debug("Spreadsheet export: "+r+"% loaded.")};var f=function(e){var t;if(typeof e.getCount==="function"){t=e.getCount()}else if(typeof e.getTotalSize==="function"){t=e.getTotalSize()}else if(!e.isA("sap.ui.model.TreeBinding")&&typeof e.isLengthFinal==="function"&&e.isLengthFinal()){t=e.getLength()}if(typeof t!=="number"||t<0||isNaN(t)){t=null}return t};u.prototype.createDataSourceFromBinding=function(e){var t=[];if(e.isA("sap.ui.model.ClientListBinding")){var r=e.getModel().getProperty(e.getPath());t={data:r instanceof Array?r:[],type:"array"}}if(e.isA("sap.ui.model.ClientTreeBinding")){s.error("Unable to create dataSource configuration due to not supported Binding: "+e.getMetadata().getName())}if(typeof e.getDownloadUrl==="function"){var o=e.getModel(),i=e.getDownloadUrl("json"),a=o.sServiceUrl,c=o.isA("sap.ui.model.odata.v4.ODataModel");i=n.interceptUrl(i);a=n.interceptUrl(a);t={type:"odata",dataUrl:i,serviceUrl:a,headers:c?o.getHttpHeaders(true):o.getHeaders(),count:f(e),useBatch:c||o.bUseBatch};if(o.getMetaModel()&&typeof o.getMetaModel().requestCurrencyCodes==="function"&&typeof o.getMetaModel().requestUnitsOfMeasure==="function"){this.codeListsPromise=u.requestCodeLists(o.getMetaModel(),this._mSettings)}}return t};u.prototype.processDataSource=function(e){var t=null;var r=typeof e;if(!e){return}if(r=="string"){return{count:this._mSettings.count,dataUrl:e,type:"odata",useBatch:false}}if(r!="object"){s.error("Spreadsheet#setDataSource: Unable to apply data source of type "+r);return}if(e instanceof Array){t={data:e,type:"array"}}if(e.dataUrl){t=e}if(e.isA&&e.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){t=this.createDataSourceFromBinding(e)}return t};function p(e,r){return new Promise(function(s,a){var u;var c=o.system.desktop?2e6:1e5;var f=r.dataSource.type=="array"?r.dataSource.data.length:r.dataSource.count;var p=r.workbook.columns.length;function l(o){if(o.progress){if(u){u.updateStatus(o.fetched,o.total)}e.onprogress(o.fetched,o.total)}if(o.finished&&e.process!==null){e.process=null;if(!o.spreadsheet){a("Spreadsheet export: The process was canceled");return}var i=e.fireEvent("beforeSave",{data:o.spreadsheet},true,true);if(u){window.setTimeout(u.finish,1e3)}if(i){n.saveAsFile(new Blob([o.spreadsheet],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),r.fileName)}s()}if(typeof o.error!="undefined"){var c=o.error.message||o.error;e.process=null;if(u){u.finish()}a(c);t.showErrorMessage(c)}}function d(){if(!r.showProgress){if(e.process){a("Cannot start export: the process is already running");return}e.process=i.execute(r,l);return}t.getProgressDialog().then(function(t){u=t;if(e.process){a("Cannot start export: the process is already running");return}u.oncancel=function(){return e.process&&e.process.cancel()};u.open();u.updateStatus(0,r.dataSource.count);e.process=i.execute(r,l)})}if(p<=0){a("No columns to export.")}else if(f*p>c||!f){t.showWarningDialog({rows:f,columns:p}).then(d).catch(function(){a("Export cancelled by the user.")})}else{d()}})}u.prototype.build=function(){var e=this._mSettings;if(this.bIsDestroyed){var t=a+": Cannot trigger build - the object has been destroyed";s.error(t);return Promise.reject(t)}return this.setDefaultExportSettings(e).then(function(){this.fireEvent("beforeExport",{exportSettings:e},false,false);n.validateSettings(e);return p(this,e)}.bind(this))};return u});