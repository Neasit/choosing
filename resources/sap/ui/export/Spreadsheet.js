/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Core","./ExportDialog","sap/ui/base/EventProvider","sap/ui/Device","sap/ui/export/SpreadsheetExport","sap/base/Log","sap/ui/export/ExportUtils"],function(e,t,r,o,n,s,a,i,u){"use strict";var c="sap.ui.export.Spreadsheet";var p=n.extend(c,{constructor:function(e){n.call(this,e);this._mSettings={fileName:"Export",showProgress:true,worker:true};["count","dataSource","fileName","fileType","showProgress","workbook","worker"].forEach(function(t){if(typeof e[t]!=="undefined"){this._mSettings[t]=t!=="dataSource"?e[t]:this.processDataSource(e[t])}}.bind(this))}});p.prototype.attachBeforeExport=function(e,t,r){return this.attachEvent("beforeExport",e,t,r)};p.prototype.detachBeforeExport=function(e,t){return this.detachEvent("beforeExport",e,t)};p.prototype.attachBeforeSave=function(e,t,r){return this.attachEvent("beforeSave",e,t,r)};p.prototype.detachBeforeSave=function(e,t){return this.detachEvent("beforeSave",e,t)};p.prototype.destroy=function(){n.prototype.destroy.apply(this,arguments);this.cancel();this.bIsDestroyed=true};p.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null}return this};p.prototype.onprogress=function(e,t){var r;if(isNaN(e)||isNaN(t)){return}r=Math.round(e/t*100);i.debug("Spreadsheet export: "+r+"% loaded.")};var f=function(e){var t;if(typeof e.getTotalSize==="function"){t=e.getTotalSize()}else if(!e.isA("sap.ui.model.TreeBinding")&&typeof e.isLengthFinal==="function"&&e.isLengthFinal()){t=e.getLength()}if(typeof t!=="number"||t<0||isNaN(t)){t=null}return t};var l=function(e){var t=[];if(e.isA("sap.ui.model.ClientListBinding")){var r=e.getModel().getProperty(e.getPath());t={data:r instanceof Array?r:[],type:"array"}}if(e.isA("sap.ui.model.ClientTreeBinding")){i.error("Unable to create dataSource configuration due to not supported Binding: "+e.getMetadata().getName())}if(typeof e.getDownloadUrl==="function"){var o=e.getModel(),n=e.getDownloadUrl("json"),s=o.sServiceUrl,a=o.isA("sap.ui.model.odata.v4.ODataModel");n=u.interceptUrl(n);s=u.interceptUrl(s);t={type:"odata",dataUrl:n,serviceUrl:s,headers:a?o.getHttpHeaders(true):o.getHeaders(),count:f(e),useBatch:a||o.bUseBatch}}return t};p.prototype.processDataSource=function(e){var t=null;var r=typeof e;if(!e){return}if(r=="string"){return{count:this._mSettings.count,dataUrl:e,type:"odata",useBatch:false}}if(r!="object"){i.error("Spreadsheet#setDataSource: Unable to apply data source of type "+r);return}if(e instanceof Array){t={data:e,type:"array"}}if(e.dataUrl){t=e}if(e.isA&&e.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){t=l(e)}return t};function d(e,t){return new Promise(function(r,n){var i;var c=s.system.desktop?2e6:1e5;var p=t.dataSource.type=="array"?t.dataSource.data.length:t.dataSource.count;var f=t.workbook.columns.length;function l(s){if(s.progress){if(i){i.updateStatus(s.fetched,s.total)}e.onprogress(s.fetched,s.total)}if(s.finished&&e.process!==null){e.process=null;if(!s.spreadsheet){n("Spreadsheet export: The process was canceled");return}var a=e.fireEvent("beforeSave",{data:s.spreadsheet},true,true);if(i){window.setTimeout(i.finish,1e3)}if(a){u.saveAsFile(new Blob([s.spreadsheet],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),t.fileName)}r()}if(typeof s.error!="undefined"){var c=s.error.message||s.error;e.process=null;if(i){i.finish()}n(c);o.showErrorMessage(c)}}function d(){if(!t.showProgress){if(e.process){n("Cannot start export: the process is already running");return}e.process=a.execute(t,l);return}o.getProgressDialog().then(function(r){i=r;if(e.process){n("Cannot start export: the process is already running");return}i.oncancel=function(){return e.process&&e.process.cancel()};i.open();i.updateStatus(0,t.dataSource.count);e.process=a.execute(t,l)})}if(f<=0){n("No columns to export.")}else if(p*f>c||!p){o.showWarningDialog({rows:p,columns:f}).then(d).catch(function(){n("Export cancelled by the user.")})}else{d()}})}p.prototype.build=function(){var e=this._mSettings;if(this.bIsDestroyed){var t=c+": Cannot trigger build - the object has been destroyed";i.error(t);return Promise.reject(t)}return this._setDefaultExportSettings(e).then(function(){this.fireEvent("beforeExport",{exportSettings:e},false,false);var t=r.getConfiguration().getFormatSettings().getCustomCurrencies();if(t){e.customconfig=e.customconfig||{};e.customconfig.currencySettings={customCurrencies:t}}u.validateSettings(e);return d(this,e)}.bind(this))};p.prototype._setDefaultExportSettings=function(e){return new Promise(function(t){var o=r.getLibraryResourceBundle("sap.ui.export",true);o.then(function(r){if(typeof e.workbook.context!=="object"){e.workbook.context={}}if(!e.workbook.context.title){e.workbook.context.title=r.getText("XLSX_DEFAULT_TITLE")}if(!e.workbook.context.sheetName){e.workbook.context.sheetName=r.getText("XLSX_DEFAULT_SHEETNAME")}t()})})};return p});