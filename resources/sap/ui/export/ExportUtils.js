/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/library","sap/m/library","./library","sap/ui/core/Core","sap/base/Log","sap/base/util/uid","sap/ui/core/Item","sap/ui/core/syncStyleClass","sap/ui/model/json/JSONModel","sap/m/Button","sap/m/CheckBox","sap/m/Dialog","sap/m/Input","sap/m/Label","sap/m/Select","sap/m/Text","sap/m/VBox","sap/ui/VersionInfo","sap/ui/util/openWindow"],function(e,t,a,r,i,n,l,o,s,u,p,f,c,d,y,g,v,m,h){"use strict";var w=t.ButtonType;var b=e.ValueState;var T=a.FileType;var S=a.EdmType;var x=null;var _=r.getLibraryResourceBundle("sap.ui.export",true);var E="sap.ui.export.ExportUtils";m.load().then(function(e){var t=/^[0-9]+\.[0-9]+/.exec(e.version);x=t?t[0]:null});function C(e,t){var a;var r={fileName:"Standard",fileType:[{key:"xlsx"}],selectedFileType:"xlsx",splitCells:false,includeFilterSettings:false,addDateTime:false};var i=Object.assign({},r,e||{});for(var n=0;n<i.fileType.length;n++){a=null;if(!i.fileType[n].text){i.fileType[n].text=t.getText(i.fileType[n].key.toUpperCase()+"_FILETYPE")}if(i.fileType[n].key===i.selectedFileType){a=i.fileType[n].key}}if(!a){i.selectedFileType=i.fileType[0].key}return i}var A={_INTERCEPTSERVICE:"sap/ushell/cloudServices/interceptor/InterceptService",interceptUrl:function(e){var t=sap.ui.require(A._INTERCEPTSERVICE);if(t){var a=t.getInstance();if(a&&a.interceptUrl){e=a.interceptUrl(e)}}return e},getExportSettingsViaDialog:function(e,t,a){return new Promise(function(i,g){var m;_.then(function(h){var T=new s;T.setData(C(e,h));var S=n();m=new f({id:S,title:h.getText("EXPORT_SETTINGS_TITLE"),horizontalScrolling:false,verticalScrolling:false,content:[new v({renderType:"Bare",width:"100%",items:[new d({text:h.getText("FILE_NAME"),labelFor:S+"-fileName"}),new c({id:S+"-fileName",value:"{/fileName}",liveChange:function(e){var t=e.getSource();var a=e.getParameter("value");var i=/[\\/:|?"*<>]/;var n=r.byId(S+"-export");var l=i.test(a);if(l){t.setValueState(b.Error);t.setValueStateText(h.getText("FILENAME_ERROR"))}else if(a.length>100){t.setValueState(b.Warning);t.setValueStateText(h.getText("FILENAME_WARNING"))}else{t.setValueState(b.None);t.setValueStateText(null)}n.setEnabled(!l)}}).addStyleClass("sapUiTinyMarginBottom"),new d({text:h.getText("SELECT_FORMAT"),labelFor:S+"-fileType",visible:false}),new y({id:S+"-fileType",width:"100%",selectedKey:"{/selectedFileType}",visible:false,items:{path:"/fileType",template:new l({key:"{key}",text:"{text}"})}}),new p({id:S+"-splitCells",selected:"{/splitCells}",text:h.getText("SPLIT_CELLS")}),new p({id:S+"-includeFilterSettings",selected:"{/includeFilterSettings}",text:h.getText("INCLUDE_FILTER_SETTINGS")}),new p({id:S+"-addDateTime",selected:"{/addDateTime}",text:h.getText("ADD_DATE_TIME"),visible:false})]}).addStyleClass("sapUiExportSettingsLabel")],endButton:new u({id:S+"-cancel",text:h.getText("CANCEL_BUTTON"),press:function(){m.close()}}),beginButton:new u({id:S+"-export",text:h.getText("EXPORT_BUTTON"),type:w.Emphasized,press:function(){if(m){m._bSuccess=true;m.close();i(T.getData())}}}),afterClose:function(){if(!m._bSuccess){g(null)}m.destroy();m=null}});m.addStyleClass("sapUiContentPadding sapUiExportSettings");m.setModel(T);if(t){o("sapUiSizeCompact",t,m)}m.open();if(a){a(m)}})})},_getReadableFilterValue:function(e){switch(e.op||e.name){case"==":return"="+e.right.value;case">":case"<":case"!=":case"<=":case">=":return e.op+e.right.value;case"between":return e.args[1].value+"..."+e.args[2].value;case"contains":return"*"+e.args[1].value+"*";case"endswith":return"*"+e.args[1].value;case"startswith":return e.args[1].value+"*";default:throw Error("getReadableFilter")}},_parseFilter:function(e){switch(e.type){case"Logical":return A._parseLogical(e);case"Binary":return A._parseBinary(e);case"Unary":return A._parseUnary(e);case"Call":return A._parseCall(e);default:throw Error("Filter type "+e.type+" not supported")}},_parseLogical:function(e){if(e.op=="&&"&&e.left.type==="Binary"&&e.right.type==="Binary"&&e.left.op===">="&&e.right.op==="<="&&e.left.left.path===e.right.left.path){return A._parseCall({args:[{path:e.left.left.path,type:"Reference"},{type:"Literal",value:e.left.right.value},{type:"Literal",value:e.right.right.value}],name:"between",type:"Call"})}return A._parseFilter(e.left).concat(A._parseFilter(e.right))},_parseBinary:function(e){if(!e.left||e.left.type!="Reference"||!e.right||e.right.type!="Literal"){return[]}return[{key:e.left.path,value:A._getReadableFilterValue(e)}]},_parseUnary:function(e){var t;if(!e.arg){return[]}t=A._parseFilter(e.arg);t[0].value="!"+t[0].value;return t},_parseCall:function(e){if(!e.args||e.args.length<2){return[]}return[{key:e.args[0].path,value:A._getReadableFilterValue(e)}]},parseFilterConfiguration:function(e,t){return new Promise(function(a,r){_.then(function(n){var l,o;l={name:n.getText("FILTER_HEADER"),items:[]};if(!e||!(e.isA("sap.ui.model.ListBinding")||e.isA("sap.ui.model.TreeBinding"))){i.error("A ListBinding is required for parsing the filter settings");r();return null}var s=e.getFilterInfo();if(s){l.items=A._parseFilter(s)}if(typeof t==="function"){l.items.forEach(function(e){o=t(e.key);e.key=o&&typeof o==="string"?o:e.key})}a(l)})})},getAvailableCloudExportTargets:function(){var e=A.getCloudExportService();return e.then(function(e){return e&&e.getSupportedTargets?e.getSupportedTargets():[]}).catch(function(){return[]})},getCloudExportService:function(){return sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getServiceAsync?sap.ushell.Container.getServiceAsync("ProductivityIntegration"):Promise.reject()},saveAsFile:function(e,t){var a,r,i;if(!(e instanceof Blob)){return}a=document.createElementNS("http://www.w3.org/1999/xhtml","a");r="download"in a;if(r){i=function(e,t){a.download=t;a.href=URL.createObjectURL(e);a.dispatchEvent(new MouseEvent("click"))}}if(typeof i==="undefined"){i=function(e){var t=new FileReader;t.onloadend=function(){var e,a;a=t.result.replace(/^data:[^;]*;/,"data:attachment/file;");e=h(a,"_blank");if(!e){window.location.href=a}};t.readAsDataURL(e)}}i(e,t)},validateSettings:function(e){var t;A._validateDataSource(e.dataSource);e.fileType=T[e.fileType]?e.fileType:T.XLSX;t="."+e.fileType.toLowerCase();e.fileName=e.fileName||"export"+t;if(!e.fileName.endsWith(t)){e.fileName+=t;i.warning(E+": fileName was missing the proper file extension - extension has been added")}if(typeof e.showProgress!=="boolean"){e.showProgress=true}A._validateWorkbook(e.workbook);if(typeof e.worker!=="boolean"){e.worker=true}A._validateScaleCustomizing(e.customizing,"currency");A._validateScaleCustomizing(e.customizing,"unit")},_validateDataSource:function(e){var t;if(!e||typeof e!=="object"){throw new Error(E+": dataSource has not been specified")}e.type=e.type||"odata";if(e.type==="array"&&!Array.isArray(e.data)){i.warning(E+": Defined type does not match the provided data")}if(Array.isArray(e.data)){e.count=e.data.length}if(e.type==="odata"&&(typeof e.dataUrl!=="string"||e.dataUrl.length===0)){throw new Error(E+": Unable to export data. No dataUrl provided.")}if(typeof e.count!=="number"||e.count<0||isNaN(e.count)||e.count%1!==0){i.info(E+": Invalid value for dataSource.count - value will be ignored");e.count=null}if(typeof e.useBatch!=="boolean"){e.useBatch=false;i.info(E+': Parameter useBatch not provided. Applying default value "false"')}else if(e.useBatch===true){if(typeof e.serviceUrl!=="string"||e.serviceUrl.length===0){e.useBatch=false;i.warning(E+": serviceUrl is required for OData batch requests")}if(typeof e.headers!=="object"){e.useBatch=false;i.warning(E+": headers are required for OData batch requests.")}}t=e.sizeLimit;if(!t||isNaN(t)||t%1!==0){var a=5e3,r=200;t=e.count?Math.round(e.count/(r*5))*r:r;t=Math.min(a,Math.max(t,r));e.sizeLimit=t;i.info(E+": No valid sizeLimit provided. sizeLimit is set to "+t)}},_validateWorkbook:function(e){if(!(e instanceof Object)||!Array.isArray(e.columns)){throw new Error(E+"column configuration is not provided. Export is not possible")}e.columns=e.columns.filter(function(e,t){var a;if(!(e instanceof Object)){i.error(E+": Column "+t+" skipped due to invalid configuration");return false}if(Array.isArray(e.property)&&e.type!==S.String&&e.type!=null){i.warning(E+": Type "+e.type+" does not support an array of properties");e.property=e.property[0]}if(typeof e.property!=="string"&&!Array.isArray(e.property)){i.error(E+": Column "+t+" skipped due to missing mandatory property");return false}e.label=e.label||(e.property instanceof Array?e.property[0]:e.property);a=e.width;if(typeof a==="string"){var n;n=a.toLowerCase();a=parseFloat(n);if(n.indexOf("em")>0){a=a*2}else if(n.indexOf("px")>0){a=a/8}}if(isNaN(a)||a<1){a=10}e.width=Math.round(a);A._validateType(e,t);A._validateString(e,"textAlign");if(e.textAlign){var l=(e.textAlign+"").toLowerCase();if(["begin","end"].indexOf(l)>-1){var o=["left","right"];l=(r.getConfiguration().getRTL()?o.reverse():o)[["begin","end"].indexOf(l)]}if(l!==""&&["left","right","center"].indexOf(l)==-1){i.warning(E+": Incorrect column alignment value "+l+' on column "'+(e.label||e.property)+'". Default alignment is used.');l=""}e.textAlign=l}["autoScale","delimiter","displayUnit","utc","wrap"].forEach(function(t){A._validateProperty(e,t,"boolean")});["inputFormat","unit","unitProperty","template","trueValue","falseValue"].forEach(function(t){A._validateString(e,t)});if(e.template&&!Array.isArray(e.property)&&typeof e.inputFormat!=="string"){i.warning(E+': Template is not applicable on a single property without inputFormat - value will be discarded on column "'+(e.label||e.property)+'".');delete e.template}if(e.type===S.Boolean&&(e.trueValue===null||e.falseValue===null)){i.warning(E+': The properties trueValue and falseValue have to be assigned correctly on column "'+(e.label||e.property)+'". Values will be discarded.');delete e.trueValue;delete e.falseValue}if(e.autoScale===true&&(e.type!==S.Number||!e.unit&&!e.unitProperty)){i.warning(E+": autoScale cannot be taken into account due to invalid configuration.");delete e.autoScale}if(e.utc!=null&&(e.type===S.Date||e.type===S.Time)){e.utc=true}if(e.type===S.DateTime){A._validateProperty(e,"utc","boolean",true)}var s=e.scale;if(e.type===S.Number&&isNaN(s)&&s!=="variable"){i.warning(E+": scale parameter for numerical column configuration is missing.")}if(typeof s==="string"){s=parseInt(s)}if(isNaN(s)){s=null}e.scale=s;if(e.valueMap&&typeof e.valueMap!=="object"){i.warning(E+': Invalid value for property "valueMap" on column "'+(e.label||e.property)+'". Value will be discarded.');delete e.valueMap}return true});A._validateWorkbookContext(e.context);A._validateString(e,"hierarchyLevel")},_validateType:function(e){var t,a;if(typeof e.type!=="string"){e.type=S.String;return}if(!S[e.type]){a=S.String;for(t in S){if(t.toLowerCase()==e.type.toLowerCase()){a=t}}i.warning(E+": Unsupported column type "+e.type+' on column "'+(e.label||e.property)+'". EdmType.'+a+" is applied.");e.type=a}if(e.type===S.Currency&&!e.unitProperty){i.warning(E+': Missing unitProperty for type Currency on column "'+(e.label||e.property)+'". Type is reverted to "String".');e.type=S.String}else if(e.type===S.Enumeration&&(!e.valueMap||typeof e.valueMap!=="object")){i.warning(E+': Invalid valueMap for type Enumeration on column "'+(e.label||e.property)+'". Type is reverted to "String".');e.type=S.String}},_validateWorkbookContext:function(e){if(!(e instanceof Object)){return}A._validateString(e,"application","SAP UI5");A._validateString(e,"version",x);A._validateString(e,"title");A._validateString(e,"modifiedBy");A._validateString(e,"sheetName","SAPUI5 Spreadsheet Export",31);A._validateString(e,"metaSheetName","Metadata",31);if(e.metainfo){if(!Array.isArray(e.metainfo)){i.warning(E+': Invalid value for property "metainfo". Value will be discarded.');e.metainfo=null}else{e.metainfo.filter(function(e,t){if(typeof e.name!=="string"||e.name.length===0){i.warning(E+": Invalid name for metainfo group at index "+t+". Entry will be discarded.");return false}return true})}}},_validateString:function(e,t,a,r){var n;A._validateProperty(e,t,"string",a);n=e[t];if(typeof n==="string"&&r&&n.length>r){i.warning(E+": The value of "+t+" exceeds the max length of "+r+" and will be truncated.");n=n.slice(0,r)}e[t]=n},_validateProperty:function(e,t,a,r){var n=e[t];if(n!=null&&typeof n!==a){i.warning(E+': Invalid value for property "'+t+". Value will be discarded.");n=null}e[t]=n==null&&r?r:n},_validateScaleCustomizing:function(e,t){var a,r;r=e[t];if(!(r instanceof Object)||Array.isArray(r)){i.warning(E+": Invalid scale customizing for "+t+".");e[t]={}}else{for(a in r){if(!(r[a]instanceof Object)){i.warning(E+": Key "+a+" has been removed from customizing.");delete r[a]}else if(typeof r[a].scale!=="number"||r[a].scale<0){i.warning(E+": Key "+a+" has been removed from customizing due to invalid scale.");delete r[a]}}}}};return A},true);