/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["jquery.sap.global","sap/base/Log","sap/ui/Device"],function(e,r,t){"use strict";var n="sap/ui/export/provider/DataProviderBase",o="sap/ui/export/js/XLSXBuilder",a="sap/ui/export/js/libs/JSZip3";function i(t,i){function s(e){if(e instanceof MessageEvent&&e.data){e=e.data}return i&&i(e)}function u(e,r){s({progress:true,fetched:e||0,total:r||0})}function c(e){s({error:e.message||e})}function f(e){s({finished:true,spreadsheet:e})}function d(){var e;var r;function i(n,o){r=n.getDataConverter(t);e=new o(t.workbook.columns,t.workbook.context,t.workbook.hierarchyLevel,t.customizing);var a=t.dataSource.data||[];var i=a.length;var s=r(a.slice());e.append(s);u(i,i);e.build().then(f)}sap.ui.require([n,o,a],i);return{cancel:f}}function l(e){if(!e){return e}try{return new URL(e,document.baseURI).toString()}catch(r){return window.URI(e).absoluteTo(document.baseURI).toString()}}function p(){var e,r;function i(n,o){var a=new n(t);e=new o(t.workbook.columns,t.workbook.context,t.workbook.hierarchyLevel,t.customizing);r=a.requestData(s)}function s(r){if(r.error||typeof r.error==="string"){return c(r.error)}e.append(r.rows);u(r.fetched,r.total);if(r.finished){e.build().then(f)}}function d(){r.cancel();f()}sap.ui.require([n,o,a],i);return{cancel:d}}function v(){var n;var o=e.extend(true,{},t);var a=typeof o.worker==="object"?o.worker:{};var i=function(){n.postMessage({cancel:true});f()};function u(e){var r=new Worker(e);r.onmessage=s;if(navigator.userAgent.indexOf("Firefox")===-1||d(e)){r.onerror=c}r.postMessage(o);return r}function d(e){return e.indexOf(window.location.host)>0||/^[^/]+\/[^/].*$|^\/[^/].*$/i.test(e)}function v(){r.warning("Direct worker is not allowed. Load the worker via blob.");var e=window.URI(a.base).absoluteTo("").search("").hash("").toString();a.src=e+a.ref;var t='self.origin = "'+e+'"; '+'importScripts("'+a.src+'")';var n=new Blob([t]);var o=window.URL.createObjectURL(n);return u(o)}function w(){r.warning("Blob worker is not allowed. Use in-process export.");i=p(o).cancel}function b(){try{n=u(a.src);n.addEventListener("error",function(e){n=v();n.addEventListener("error",function(e){w();e.preventDefault()});e.preventDefault()})}catch(e){try{n=v()}catch(e){w()}}}o.dataSource.dataUrl=l(o.dataSource.dataUrl);o.dataSource.serviceUrl=l(o.dataSource.serviceUrl);a.base=a.base||sap.ui.require.toUrl("sap/ui/export/js/","");a.ref=a.ref||"SpreadsheetWorker.js";a.src=a.base+a.ref;b();return{cancel:function(){i()}}}if(t.dataSource.type==="array"){return d()}else if(t.worker===false||sap.ui.disableExportWorkers===true){return p()}else{return v()}}return{execute:i}},true);