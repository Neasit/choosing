/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["jquery.sap.global","sap/base/Log","sap/ui/Device"],function(e,r,t){"use strict";var o="sap/ui/export/provider/DataProviderBase",n="sap/ui/export/js/XLSXBuilder",a="sap/ui/export/js/libs/JSZip3";function i(i,s){function u(e){if(e instanceof MessageEvent&&e.data){e=e.data}return s&&s(e)}function c(e,r){u({progress:true,fetched:e||0,total:r||0})}function f(e){u({error:e.message||e})}function d(e){u({finished:true,spreadsheet:e})}function l(){var e;var r;function t(t,o){r=t.getDataConverter(i);e=new o(i.workbook.columns,i.workbook.context,i.workbook.hierarchyLevel,i.customconfig);var n=i.dataSource.data||[];var a=n.length;var s=r(n.slice());e.append(s);c(a,a);e.build().then(d)}sap.ui.require([o,n,a],t);return{cancel:d}}function p(e){if(!e){return e}try{return new URL(e,document.baseURI).toString()}catch(r){return window.URI(e).absoluteTo(document.baseURI).toString()}}function v(){var e,r;function t(t,o){var n=new t(i);e=new o(i.workbook.columns,i.workbook.context,i.workbook.hierarchyLevel,i.customconfig);r=n.requestData(s)}function s(r){if(r.error||typeof r.error==="string"){return f(r.error)}e.append(r.rows);c(r.fetched,r.total);r.finished&&e.build().then(d)}function u(){r.cancel();d()}sap.ui.require([o,n,a],t);return{cancel:u}}function w(){var t;var o=e.extend(true,{},i);var n=typeof o.worker==="object"?o.worker:{};var a=function(){t.postMessage({cancel:true});d()};function s(e){var r=new Worker(e);r.onmessage=u;if(navigator.userAgent.indexOf("Firefox")===-1||c(e)){r.onerror=f}r.postMessage(o);return r}function c(e){return e.indexOf(window.location.host)>0||/^[^/]+\/[^/].*$|^\/[^/].*$/i.test(e)}function l(){r.warning("Direct worker is not allowed. Load the worker via blob.");var e=window.URI(n.base).absoluteTo("").search("").hash("").toString();n.src=e+n.ref;var t='self.origin = "'+e+'"; '+'importScripts("'+n.src+'")';var o=new Blob([t]);var a=window.URL.createObjectURL(o);return s(a)}function w(){r.warning("Blob worker is not allowed. Use in-process export.");a=v(o).cancel}function b(){try{t=s(n.src);t.addEventListener("error",function(e){t=l();t.addEventListener("error",function(e){w();e.preventDefault()});e.preventDefault()})}catch(e){try{t=l()}catch(e){w()}}}o.dataSource.dataUrl=p(o.dataSource.dataUrl);o.dataSource.serviceUrl=p(o.dataSource.serviceUrl);n.base=n.base||sap.ui.require.toUrl("sap/ui/export/js/","");n.ref=n.ref||"SpreadsheetWorker.js";n.src=n.base+n.ref;b();return{cancel:function(){a()}}}if(i.dataSource.type==="array"){return l()}else if(i.worker===false||sap.ui.disableExportWorkers===true||t.browser.msie&&i.dataSource.dataUrl.indexOf(".")===0){return v()}else{return w()}}return{execute:i}},true);