/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
(function(e){"use strict";if(typeof sap!=="undefined"&&typeof sap.ui.define==="function"){sap.ui.define([],e,true)}else{var t;if(typeof window!=="undefined"){t=window}else if(typeof self!=="undefined"){t=self}else{t=this}t.DataProviderBase=e()}})(function(){"use strict";var e=function(t){this.mSettings=t;this.bCanceled=false;this.iAvailableRows=0;this.mRequest=null;this.iTotalRows=Math.min(t.dataSource.count||e.MAX_ROWS,e.MAX_ROWS);this.iBatchSize=Math.min(t.dataSource.sizeLimit||e.MAX_ROWS,this.iTotalRows);this._prepareDataUrl()};e.MAX_ROWS=1048575;e.HTTP_ERROR_MSG="HTTP connection error";e.HTTP_WRONG_RESPONSE_MSG="Unexpected server response:\n";e._createGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,r=e==="x"?t:t&3|8;return r.toString(16)})};e.getColumnsToConvert=function(e){return e.workbook.columns.reduce(function(e,t){var r;r=t.property instanceof Array?t.property:[t.property];if(t.unitProperty){r.push(t.unitProperty)}r.forEach(function(r){var i=r.split("/");if(i.length>1){e.push({property:r,keys:i,type:t.type})}});return e},[])};e.getDataConverter=function(t){var r=this.getColumnsToConvert(t);return function(t){return e._convertData(t,r)}};e._convertData=function(t,r){r.forEach(function(r){t.forEach(function(t){t[r.property]=e._getValue(t,r)})});return t};e._getValue=function(e,t){var r=t.keys.reduce(function(e,t){return e&&e[t]},e);return r};e.prototype.requestData=function(t){var r=this.mSettings.dataSource;this.fnConvertData=e.getDataConverter(this.mSettings);this.fnProcessCallback=t;this.mRequest={serviceUrl:this._cleanUrl(r.serviceUrl),dataUrl:this._getUrl(0,this.iBatchSize),method:r.useBatch?"BATCH":"GET",headers:r.headers};this.sendRequest(this.mRequest).then(this.fnOnDataReceived.bind(this)).catch(this.fnOnError.bind(this));return{cancel:function(){this.bCanceled=true;if(this.oPendingXHR instanceof XMLHttpRequest){this.oPendingXHR.abort()}}.bind(this)}};e.prototype.fnOnDataReceived=function(e){var t,r,i,n;var s={};this.oPendingXHR=null;if(this.bCanceled){return}t=e&&e.value||e.d&&(e.d.results||e.d)||e;t=Array.isArray(t)?t:[];i=t.length;this.iAvailableRows+=i;n=this.iTotalRows-this.iAvailableRows;s.finished=i===0||n<=0;s.progress=this.iTotalRows;s.total=this.iTotalRows;s.fetched=this.iAvailableRows;r=e&&e["@odata.nextLink"]||e.d&&e.d.__next||null;if(!s.finished){this.mRequest.dataUrl=this._getUrl(this.iAvailableRows,Math.min(this.iBatchSize,n),r);this.sendRequest(this.mRequest).then(this.fnOnDataReceived.bind(this)).catch(this.fnOnError.bind(this))}s.rows=this.fnConvertData(t);this.fnProcessCallback(s)};e.prototype.fnOnError=function(e){this.fnProcessCallback({error:e})};e.prototype._cleanUrl=function(e){var t;if(!e){return""}t=URI.parse(e);t.path=t.path||"";if(t.path.slice(-1)!=="/"){t.path=t.path+"/"}delete t.query;delete t.hash;delete t.fragment;return(URI.serialize||URI.build)(t)};e.prototype._prepareDataUrl=function(){var e=this.mSettings.dataSource;var t,r=/\$skip\=[0-9]+/,i=/\$top\=[0-9]+/;if(!e.dataUrl){return""}t=URI.parse(e.dataUrl);t.query=t.query||"";if(!r.test(t.query)){t.query+=(t.query.length?"&":"")+"$skip="+0}if(!i.test(t.query)){t.query+="&$top="+0}this.mSettings.dataSource.dataUrl=(URI.serialize||URI.build)(t)};e.prototype._getUrl=function(e,t,r){var i,n;i=URI.parse(this.mSettings.dataSource.dataUrl);if(r){n=URI.parse(r);i.query=n.query}else{i.query=(i.query||"").replace(/\$skip\=[0-9]+/g,"$skip="+e).replace(/\$top\=[0-9]+/g,"$top="+t)}return(URI.serialize||URI.build)(i)};e.prototype.sendRequest=function(e){var t;if(typeof e!=="object"||e===null||typeof e.dataUrl!=="string"){throw new Error("Unable to send request - Mandatory parameters missing.")}t=(e.method==="BATCH"&&e.serviceUrl?this.sendBatchRequest:this.sendGetRequest).bind(this);return t(e)};e.prototype.sendBatchRequest=function(t){return new Promise(function(r,i){var n=new XMLHttpRequest;var s="batch_"+e._createGuid();var a=t.dataUrl.split(t.serviceUrl)[1];var o=[];var u,h;n.onload=function(){var t,n,s,a,o,u,h;n=this.responseText.split("\r\n");o=0;a=n.length;s=a-1;n.forEach(function(e){h=e.match(/HTTP\/1\.[0|1] ([1-9][0-9]{2})/);if(Array.isArray(h)&&h[1]){u=h[1]}});while(o<a&&n[o].slice(0,1)!=="{"){o++}while(s>0&&n[s].slice(-1)!=="}"){s--}n=n.slice(o,s+1);t=n.join("\r\n");if(u&&parseInt(u)>=400){i(e.HTTP_WRONG_RESPONSE_MSG+t);return}try{r(JSON.parse(t))}catch(r){i(e.HTTP_WRONG_RESPONSE_MSG+t)}};n.onerror=function(){i(e.HTTP_ERROR_MSG)};n.open("POST",t.serviceUrl+"$batch",true);n.setRequestHeader("Accept","multipart/mixed");n.setRequestHeader("Content-Type","multipart/mixed;boundary="+s);o.push("--"+s);o.push("Content-Type: application/http");o.push("Content-Transfer-Encoding: binary");o.push("");o.push("GET "+a+" HTTP/1.1");for(u in t.headers){h=t.headers[u];if(u.toLowerCase()!="accept"){n.setRequestHeader(u,h)}o.push(u+":"+h)}o.push("");o.push("");o.push("--"+s+"--");o.push("");o=o.join("\r\n");n.send(o);this.oPendingXHR=n}.bind(this))};e.prototype.sendGetRequest=function(t){return new Promise(function(r,i){var n;var s=new XMLHttpRequest;s.onload=function(){if(this.status>=400){i(this.responseText||this.statusText||e.HTTP_ERROR_MSG);return}try{r(JSON.parse(this.responseText))}catch(t){i(e.HTTP_WRONG_RESPONSE_MSG+this.responseText)}};s.onerror=function(){i(e.HTTP_ERROR_MSG)};s.open("GET",t.dataUrl,true);s.setRequestHeader("accept","application/json");for(n in t.headers){if(n.toLowerCase()!=="accept"){s.setRequestHeader(n,t.headers[n])}}s.send();this.oPendingXHR=s}.bind(this))};return e});